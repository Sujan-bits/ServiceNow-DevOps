# Starter pipeline
# This pipeline now includes a step to create/update a ServiceNow Change Request
# before deploying the application via the Update Set.

# trigger:
# - main

pool: mySelfHostedAP

stages:
# 1. This stage is to Create ServiceNow Change Request
- stage: CreateChangeRequest
  displayName: 'Create ServiceNow CR'
  jobs:
    - job: CreateCRJob
      displayName: 'Create ServiceNow Change Request'
      pool: 
       name: server
      steps:
        - task: ServiceNow-DevOps-Server-Change-Acceleration@1
          displayName: 'Create ServiceNow Change Request'
          name: ChangeAccelTask  # Naming the task to reference its outputs later
          inputs:
            connectedServiceName: dev251858-ServiceNow-DevOps
            changeRequestDetails: |
              {
                "attributes": {
                  "chg_model": {
                    "name": "DevOps Simplified"
                  },
                  "requested_by": {
                    "name": "DevOps Integration User"
                  },
                  "assignment_group": {
                    "name": "CAB Approval"
                  },
                  "priority": "2",
                  "short_description": "Change request to move stories to Production",
                  "description": "Automated Change Request created through pipeline for Production deployment",
                  "work_notes": "Hi CAB Team, Please approve this change",
                  "start_date": "2025-10-02 05:59:59",
                  "end_date": "2025-10-02 11:59:59"
                }
              }

# 2. This stage is to deploy the application
- stage: DeploytoTarget
  displayName: 'Deploy to Target'
  dependsOn: CreateChangeRequest # Ensure this deployment waits for the CR to be created
  jobs: 
  - deployment: DeployApp
    displayName: 'Deploy Application'
    environment: 'Target-instance'
    strategy:
     runOnce:
       deploy:
         steps:
           - task: ServiceNow-CICD-SC-Apply@2
             displayName: 'Apply ServiceNow Update Set'
             inputs:
               connectedServiceName: ServiceNow-CICD
               appScope: x_1126772_project
               appSysId: d70bf8a183003210109ac5b5eeaad371
               branchName: main
